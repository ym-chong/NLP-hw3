# -*- coding: utf-8 -*-
import jieba
import re
import numpy as np
from gensim.models import Word2Vec
from gensim.models.word2vec import LineSentence
from sklearn.cluster import KMeans

def read_novel(novel_path, output_path):  # 读取语料内容
    content = []
    with open(novel_path, 'r', encoding='ANSI') as novel_file:
        for line in novel_file:
            line = line.strip('\n')
            line = line.replace('本书来自www.cr173.com免费txt小说下载站', '')
            line = line.replace('更多更新免费电子书请关注www.cr173.com', '')
            line = re.sub(r'[^\u4e00-\u9fa5]', '', line)
            con = jieba.cut(line, cut_all=False)  # 结巴分词
            con = content_deal(con)
            content.append(" ".join(con))
    with open(output_path, "w", encoding='utf-8') as f:
        f.writelines(content)
    return content

def get_paragraph_vector(paragraph, model):  # 计算段落向量（采用平均词向量表示）
    words = jieba.lcut(paragraph)
    vectors = [model.wv[word] for word in words if word in model.wv]
    if len(vectors) > 0:
        return np.mean(vectors, axis=0)
    else:
        return np.zeros(model.vector_size)

def content_deal(content):  # 语料预处理
    with open('cn_stopwords.txt', "r", encoding='utf-8') as f:
        ad = [line.strip() for line in f]
    return [word for word in content if word not in ad]

if __name__ == '__main__':
    novel_path = "金庸小说集/白马啸西风.txt"  # 修改为具体的小说文件路径
    output_path = "output/白马啸西风_fenci.txt"  # 输出文件路径
    novel_content = read_novel(novel_path, output_path)

    model = Word2Vec(sentences=LineSentence(output_path), hs=1, min_count=10, window=5, vector_size=200, sg=0, epochs=200)

    # 白马啸西风
    word = "苏普"
    word_list = ['李文秀', '苏普', '高昌', '阿曼']
    paragraph1 = "李文秀道：「我爹爹妈妈一定知道你的名字，我到回疆来时只有八岁，甚麽也不懂。」华辉脸色转愉，道：「那就是了。你……」一句话没说完，忽听洞外山道中有人说道：「定是躲在这儿，小心她的毒针！」跟著脚步声响，三个人一步一停的进来。"
    paragraph2 = "华辉忙取出毒针，将针尾插入木杖的杖头，交了给她，指著进口之处，低声道：「等人进来後刺他背心，千万不可性急而刺他前胸。」"
    # 碧血剑
    # word = "袁承志"
    # word_list = ['袁承志', '青青', '华山']
    # paragraph1 = "焦姑娘泪流满面，牵了兄弟的手出去，走到门口，停步回头，道：“爹，难道你除了死给他们看之外，真的没第二条路了？”焦公礼道：“甚么路子我都想过了，如能不死，难道不想么？唉！这世上只有一个人能救得我性命，可是这人多半已不在世了。”焦姑娘脸上露出光彩，忙走近两步，道：“爹，那是谁？或许他没有死呢？”焦公礼道：“这位恩公姓夏，外号叫做金蛇郎君。”袁承志和青青听了，都大吃一惊。"
    # paragraph2 = "焦夫人与众弟子听说到了救星，虽想不论他武功如何了得，以一人之力，终究难与对方这许多高手相抗，但焦公礼既然如此放心，必有道理，登时都是喜慰不已。焦公礼要他们四散避难，大家本来不愿，现下自然都不走了。袁承志和青青从焦家出来，青青问道：“你画这柄剑是甚么意思？”袁承志道：“焦公礼说世上只有你爹爹一到，才能救他性命。我画的就是你爹爹用的金蛇剑。”"
    # 飞狐外传
    # word = "胡斐"
    # word_list = ['胡斐', '袁紫衣', '凤天南', '程灵素']
    # paragraph1 = "两人进退邀击，又拆了数招，胡斐突然领悟，原来苗人凤这时所使招数，全是用的“后发制人”之术，要待双方筷子相交，他才随机应变，这正是所谓“以客犯主”、“迟胜于急”等等的道理。"
    # paragraph2 = "胡斐一言不发，听他说完，隔了半晌，才问道：“如此说来，这位好朋友是你亲手杀死的了？”苗人凤道：“正是。”胡斐道：“那人的夫人呢？你斩草除根，一起杀了？”"
    # 连城诀
    # word = "狄云"
    # word_list = ['狄云', '戚芳', '神照经']
    # paragraph1 = "宝象见狄云闪避灵活，小船顺着江水飘行，越来越远，当即用力掷出两块石头，却对准了小船。他若一出手便即掷船，小小一艘木船立时便会洞穿沉没，但这时相距已远，接连几块石头虽都打在船上，却劲力已衰，只打碎了些船舷、船板而已。"
    # paragraph2 = "狄云听得清清楚楚，宝象是在刀砍丁典。虽然丁典已死，早已无知无觉，但在狄云心中，那仍是他至敬至爱的义兄，这一刀便如是砍在自己身上一般，立时便想冲出去拚命，但这五年的牢狱折磨，已将这朴实卤莽的少年变成个遇事想上几想的青年。刚一动念，跟着便想：“我冲出去和他厮拚，除了送掉自己性命，更无别样结果。丁大哥和凌小姐合葬的心愿便不能达成。那如何对得起他？”"
    # 鹿鼎记
    # word = "韦小宝"
    # word_list = ['韦小宝', '天地会', '康熙']
    # paragraph1 = "阿珂拉住韦小宝的手，急得要哭了出来，道：“怎么办？怎么办？”韦小宝道：“一万两银子我倒有，只是送给他还赌帐嫖帐，可不大愿意。”阿珂道：“他们要割他耳朵了，你就……你就借给我罢。”韦小宝道：“师姊要错，别说一万两，就十万两也借了，不过日后你是我妻子，我笔帐不能算。你叫郑公子向我借。”阿珂顿足道：“唉，你这人真是。”叫道：“喂，你们别打，还你们钱就是。”众侍卫打得够了，便即住手，但仍是按住郑克爽不放。"
    # paragraph2 = "拍的一声响，一名侍卫又重重的打了郑克爽一个耳光。他手脚全被拉住，绝无抗拒之力。一名侍卫喝道：“狠狠的打，打死了他，这一万两银子，就算掉在水里。这叫做眼不见，心不烦。”劈劈拍拍，又打了起来。郑克爽叫道：“别打！别打！韦兄弟，你手边如有银子，就请借给我一万两，我……我保证一定归还。”韦小宝斜眼瞧着阿珂，道：“师姊，你说借不借？”"
    # 射雕英雄传
    # word = "郭靖"
    # word_list = ['郭靖', '黄蓉', '杨康']
    # paragraph1 = "欧阳锋先见黄药师中了机关，心中暗笑，这时见他走近洞壁细看，心想这里一针一线之微，都会干连到能否取得《九阴真经》的大事，万万忽略不得，忙也上前凑近去看，只见洞壁上用尖利之物刻着字道：“黄老邪，我给你打断双腿，在这里关了一十五年，本当也打断你的双腿，出口恶气。后来想想，饶了你算了。奉上大粪成堆，臭尿数罐，请啊请啊……”在这“请啊请啊”四字之下，粘着一张树叶，把下面的字盖没了。黄药师伸手揭起树叶，却见叶上连着一根细线，随手一扯，猛听得头顶忽喇喇声响，立时醒悟，忙向左跃开。欧阳锋见机也快，一见黄药师身形晃动，立时跃向右边，哪知乒乒乓乓一阵响亮，左边右边山洞顶上同时掉下几只瓦罐，两人满头满脑都淋满了臭尿。"
    # paragraph2 = "洪七公大叫：“好香，好香！”哈哈大笑。黄药师气极，破口大骂。欧阳锋喜怒不形于色，却只笑了笑。黄蓉飞奔回去，取了衣履给父亲换过，又将父亲的一件长袍给欧阳锋换了。黄药师重入岩洞，上下左右仔细检视，再无机关，到那先前树叶遮没之处看时，见写着两行极细之字：“树叶决不可扯，上有臭尿淋下，千万千万，莫谓言之不预也。”黄药师又好气又好笑，猛然间想起，适才臭尿淋头之时，那尿尚有微温，当下返身出洞，说道：“老顽童离去不久，咱们追他去。”郭靖心想：“两人碰上了面，必有一番恶斗。”待要出言劝阻，黄药师早已向东而去。"
    # 神雕侠侣
    # word = "杨过"
    # word_list = ['杨过', '小龙女', '李莫愁']
    # paragraph1 = "这一笑之下，两人本来存著的相互戒备之心登时去了大半。李莫愁脸上充满温柔之 色，口中低声哼著歌儿，一手轻拍，抱起婴儿。杨过找些软草，在树荫下一块大石上做 了个窝儿，说道：「你放她在这儿睡罢！」李莫愁忙做个手势，命他不可大声惊醒了孩 子。杨过伸伸舌头，做个鬼脸，眼见孩子睡得甚是宁静，不禁呼了一口长气，回头只见 两头小豹正钻在母豹怀中吃奶。"
    # paragraph2 = "黄蓉初时见她在棘藤圈中乱转，正自暗喜，忽见她纵身跃开，却也好生佩服：「这 女魔头拿得起，放得下，决断好快。她得享大名，果非幸致，看来实是劲敌。」这时女 儿已置於万无一失之地，心中再无牵挂，挥竹棒使招「按狗低头」，向李莫愁後颈捺落 。李莫愁拂尘倒卷，缠向竹棒，刷的一声，帚丝直向黄蓉面门击来。两人以快打快，各 展精妙招术，顷刻间已拆了数十招。"
    # 书剑恩仇录
    # word = "陈家洛"
    # word_list = ['陈家洛', '红花会', '乾隆']
    # paragraph1 = "各人驰了十八九里，狼粪越来越湿。关明梅道：“狼群就在前面了。怎么听到了这许多驼马叫声，竟不追来？”陈正德道：“这也真奇了。”再走数里，地势陡变，见群山围绕，中间一座白玉高峰参天而起。天山双鹰久在大漠，早听说过这玉峰的诸般神奇传说，不意今日得能亲见，只见阳光斜照玉峰，隐隐泛彩，奇丽无伦。"
    # paragraph2 = "狼群虽然凶狠顽强，但奔跑的长力不够，十多里后，已给抛得不见踪影。再驰出十多里，袁士霄叫道：“休息一会吧！”众人下马喝水吃肉。哈合台把驼马赶在一块。袁士霄见他约束牲口的本领极精，笑道：“多亏了你。”待得狼群追近，驼马队已休息了好一会。这般追追停停，向南直跑了七八十余里。前面尘头起处，两名回人驰到，叫道：“袁老爷子，成功了么？”袁士霄道：“来啦，来啦！你叫大伙儿预备。”两名回人掉头先行。众人见前面有了接应，放下了一大半心。"
    # 天龙八部
    # word = "段誉"
    # word_list = ['段誉', '萧峰', '阿紫']
    # paragraph1 = "萧峰悄悄走近，隐身石后，望将出去，只见火焰旁聚集了十多人，一色的麻葛布衫，绿油油的火光照映之下，阿紫，她双手已被铁铐铐住，雪白的脸给绿火一映，看上去也甚诡异。众人默不作声的注视火焰，左掌按胸，口中喃喃的不知说些什么。萧峰知道这些邪魔外道各有呼的怪异仪式，也不去理会。他听适才那名星宿弟子说“大师哥到了，多半已拿住了小师妹”，见这十余人有老有少，服饰一般无二，动作神态之中，也无哪一个特别显出颐指气使的厝样。"
    # paragraph2 = "忽听得“呜呜呜”几下柔和的笛声从东北方飘来，众人转过身子，齐向着笛声来处躬身行礼。阿紫小嘴微微翘，却不转身。萧峰向着笛声来处瞧去，只见一个白衣人影飘行而来，脚下甚是迅捷，片刻间便走到火焰鼓气一吹，那火焰陡地熄灭，随即大亮，蓬的一声响，腾向半空，升起有丈许，这才缓缓降低，众人高呼“：大师兄去力神奇令我等大开眼界。”"
    # 侠客行
    # word = "石破天"
    # word_list = ['石破天', '阿绣', '石中玉']
    # paragraph1 = "阿绣曲膝慢慢跪下，坐在自己脚跟上，问道：“你有没听到我的话？”石破天道：“听到的。这一招叫做旁敲……旁敲什么的。”这一次他倒不是没用心听，只因‘旁敲侧击’四字是个文诌诌的成语，他不明其意，就说不上来。"
    # paragraph2 = "石破天听得好生佩服，道：“阿绣，你小小年纪，怎么懂得这许多事情？这个法子真是再好也没有了。”阿绣花笑道：“我话说无了，你回过头来吧。”"
    # 笑傲江湖
    # word = "令狐冲"
    # word_list = ['令狐冲', '岳不群', '东方不败']
    # paragraph1 = "令狐冲心想恒山派是五岳剑派之一，掌门人就任倘若太过草草，未免有损恒山派威名，点头称是。仪清取过一本历书，翻阅半晌，说道：“二月十六、三月初八、三月二十七，这三天都是黄道吉日，大吉大利。掌门师兄你瞧那一天合适？”"
    # paragraph2 = "仪清道：“正月里好日子倒也不少，不过都是利于出行、破土、婚姻、开张等等的，要到二月里，才有利于‘接印、坐衙？’的好日子。”令狐冲笑道：“我又不是做官，什么接印、坐衙？”仪和笑道：“你不是做过大将军吗？做掌门人，也是接印。”"
    # 雪山飞狐
    # word = "胡一刀"
    # word_list = ['胡斐', '胡一刀', '苗人凤']
    # paragraph1 = "「金面佛道：『胡兄，这批没出息的家伙吵得你难以安睡。咱们今日停战，你好好睡一觉，明日再比。』胡一刀笑道：『是内人打发的，兄弟睡著不知。来吧！』单刀一振，立个门户。」"
    # paragraph2 = "「这一日打到天黑，仍是不分胜负。金面佛收剑道：『胡兄，今日兄弟不回去啦，想跟你痛饮一番，然后抵足而眠，谈论武艺。』胡一刀大笑，叫道：『妙极，妙极。兄弟参研苗兄剑法，尚有许多不明之处，今晚正好领教。』金面佛向范帮主、田相公道：『你们走吧，今晚我住在这里。』」"
    # 倚天屠龙记
    # word = "赵敏"
    # word_list = ['张无忌', '赵敏', '周芷若', '灭绝师太']
    # paragraph1 = "张无忌道：“此剑是峨嵋派所有，何以到了你的手中？”赵敏啐道：“小鬼，你懂得什么？灭绝老尼从我家中盗得此剑，此刻物归原主，倚天剑跟峨嵋派有什么干系？”"
    # paragraph2 = "张无忌原不知倚天剑的来历，给她反口一问，竟是答不上来，当下岔开话题，说道：“赵姑娘，请你取‘黑玉断续膏’给我，治好了我三师伯、六师叔的断肢，大家便既往不咎。”赵敏道：“哼！既往不咎？说来倒容易。你可知少林派空闻、空智，武当派的宋远桥、俞莲舟他们，此刻都在何处？”张无忌摇头道：“我不知道。还请姑娘见示。”"
    # 鸳鸯刀
    # word = "林玉龙"
    # word_list = ['林玉龙', '任飞燕', '袁冠南', '萧中慧']
    # paragraph1 = "萧中慧道：「你们既是夫妻，怎地又打又骂，又动刀子？」任飞燕冷笑道：「哈哈，大姑娘，等你嫁了男人，那就明白啦。夫妻若是不打架，那还叫什麽夫妻？有道是床头打架床尾合，你见过不吵嘴不打架的夫妻没有？」"
    # paragraph2 = "任飞燕替丈夫包好伤口，回头却不见了儿子，惊道：「儿子呢？」林玉龙「啊哟」一声，跳了起来，说道：「给那贱人抱走啦。」任飞燕道：「你怎不早说？」林玉龙道：「你自己抱著的，谁叫你放在地下？」任飞燕大怒，飞身上前，吧的一声，打了他一个嘴巴，喝道：「我给你包伤口啊！死人！」林玉龙回了一拳，骂道：「儿子也管不住，谁要你讨好？」任飞燕道：「畜生，快去抢回儿子，回头在跟你算帐。」说著拔步狂追。"
    # 越女剑
    # word = "范蠡"
    # word_list = ['阿青', '范蠡', '西施', '勾践']
    # paragraph1 = "想到和西施重逢的时刻指日可期，不由得心口感到一阵热烘烘得暖意，说道：“我叫范蠡，姑娘，请你到我家吃饭去。”阿青道：“我不去，我要赶羊去吃草。”范蠡道：“我家里有大好的草地，你赶羊去吃，我再赔你十头肥羊。”"
    # paragraph2 = "如果阿青要杀的是他自己，范蠡不会害怕的，然而她要杀的是西施。“范蠡，范蠡！我要杀了你的西施，她逃不了的！”阿青的声音忽东忽西，在宫墙外传进来。范蠡定了定神，说道：“我要去见见这人。”轻轻放脱了西施的手，快步向宫门走去。"
    # 三十三剑客图
    # word = "卢生"
    # word_list = ['虬髯', '卢生', '唐山人']
    # paragraph1 = "唐山人出外游历，在楚州的客栈之中，遇到一位姓卢的书生，言谈之下，甚是投机。卢生也谈判到炉火修炼的方术，又说他妈妈姓唐，于是便叫唐山人为舅舅。两人越谈越是高兴，当真相见恨晚。唐山人要到南岳山去，便邀卢生同行。"
    # paragraph2 = "据我猜想，卢生早闻唐山人之名，想骗他传授发财秘诀，所以“舅舅、舅舅”的叫得十分亲热，待唐山人坚执不肯，便出匕首威胁，“师父是仙人”云云，只是吓吓唐山人而已。又或许唐山人的名气大了，大家追住了要他传法，事实上他根本不会，只好造了个故事来推托。"

    # 1. 计算词向量之间的语意距离
    similar_words = model.wv.similar_by_word(word, topn=10)
    print(f"Similar words to {word}: {similar_words}")

    # 2. 进行词向量聚类
    vectors = [model.wv[word] for word in word_list]
    kmeans = KMeans(n_clusters=2)
    kmeans.fit(vectors)
    for i, word in enumerate(word_list):
        print(f"{word} belongs to cluster {kmeans.labels_[i]}")

    # 3. 计算段落间的语义距离
    vector1 = get_paragraph_vector(paragraph1, model)
    vector2 = get_paragraph_vector(paragraph2, model)
    norm1 = np.linalg.norm(vector1)
    norm2 = np.linalg.norm(vector2)
    if norm1 != 0 and norm2 != 0:
        similarity = np.dot(vector1, vector2) / (norm1 * norm2)
        print(f"The similarity between paragraph1 and paragraph2 is: {similarity}")
    else:
        print("Warning: One of the vectors is a zero vector")
